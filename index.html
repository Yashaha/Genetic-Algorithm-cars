<!DOCTYPE html>
<html>
<head>
    <title>遗传算法小车</title>
    <meta charset="utf-8"/>
    <style>
        #camera{
            width:1200px;
            height:600px;
            overflow: hidden;
        }
    </style>
</head>
<body onload="init();">
<div id="camera" style="border: 1px solid red;">
    <canvas id="canvas" width="1200" height="600" style="background-color:#333333;"></canvas>
</div>
</body>
<script type="text/javascript" src="Box2D.js"></script>
<script type="text/javascript" src="chromosome_info.js"></script>
<script type="text/javascript" src="createGround.js"></script>
<script type="text/javascript" src="createCar.js"></script>
<script type="text/javascript" src="fitness.js"></script>
<script>
    var   b2Vec2 = Box2D.Common.Math.b2Vec2
    ,	b2BodyDef = Box2D.Dynamics.b2BodyDef
    ,	b2Body = Box2D.Dynamics.b2Body
    ,	b2FixtureDef = Box2D.Dynamics.b2FixtureDef
    ,	b2Fixture = Box2D.Dynamics.b2Fixture
    ,	b2World = Box2D.Dynamics.b2World
    ,	b2MassData = Box2D.Collision.Shapes.b2MassData
    ,	b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
    ,	b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
    ,	b2DebugDraw = Box2D.Dynamics.b2DebugDraw
    ,   b2DistanceJoint = Box2D.Dynamics.Joints.b2DistanceJoint
    ,   b2DistanceJointDef = Box2D.Dynamics.Joints.b2DistanceJointDef
    ,   b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef
;

    function init() {
        var canvas = document.getElementById("canvas");
        var context = canvas.getContext("2d");
        var worldScale = 30;
        var world = new b2World(new b2Vec2(0, 9.8),true);
        var camera = {
            x:0,
            y:0
        }
        var initChromosomeGroup = new Array();//初始种群染色体
        createGround(world);
        for(var i = 0;i < 10;i++){
            initChromosomeGroup[i] = randomChromosome(8);
            createCar(world,initChromosomeGroup[i]);
        }
        debugDraw();
        setInterval(function(){update()}, 1000/60);

        //函数
        function debugDraw(){
            var debugDraw = new b2DebugDraw();
            debugDraw.SetSprite(document.getElementById("canvas").getContext("2d"));
            debugDraw.SetDrawScale(30.0);
            debugDraw.SetFillAlpha(0.1);
            debugDraw.SetLineThickness(1.0);
            debugDraw.SetFlags(b2DebugDraw.e_shapeBit | b2DebugDraw.e_jointBit);
            world.SetDebugDraw(debugDraw);
        };
        function update() {
            context.clearRect(camera.x,camera.y,1200,600);
            world.Step(1/60,10,10);
            world.DrawDebugData();
            world.ClearForces();
            update_camera();
        };
        function update_camera() {
            var target_x,target_y;
            var x_old = camera.x;
            var y_old = camera.y;
            var b_first = world.m_bodyList;
            for(var b = world.m_bodyList; b != null; b = b.m_next){
                if (b.GetUserData() == "carcircle"){
                    if (b_first.GetPosition().x < b.GetPosition().x)
                        b_first = b;
                }
            }
            target_x = b_first.GetPosition().x * worldScale;
            target_y = b_first.GetPosition().y * worldScale;
            camera.x = target_x - 600;
            camera.y = target_y - 400;
            context.translate(x_old-camera.x, y_old-camera.y);
        }
        function del() {
            //销毁车身和轮子的fixture，刚体仍然存在
            for(var b = world.GetBodyList(); b != null; b = b.GetNext())
                if (b.GetUserData() == "carbody" || b.GetUserData() == "carcircle")
                    for(var f = b.GetFixtureList(); f != null; ){
                        var f1 = f.GetNext();
                        b.DestroyFixture(f);
                        f = f1;
                    }

            //销毁所有关节
            for(var j = world.GetJointList(); j != null;){
                var j1 = j.GetNext();
                world.DestroyJoint(j);
                j = j1;
            }


            //重新设置刚体位置
            /*for(var b = world.GetBodyList(); b != null; b = b.GetNext()){
                if (b.GetUserData() == "carbody"){
                    b.SetPosition(new b2Vec2(25, 11.5));
                }
            }*/

        }



    }
</script>
</html>